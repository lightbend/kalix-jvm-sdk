/*
 * Copyright 2021 Lightbend Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.lightbend.akkasls.codegen.java

import munit.Location

class ValueEntitySourceGeneratorSuite extends munit.FunSuite {

  test("ValueEntity source") {

    val service = TestData.simpleEntityService()
    val entity = TestData.valueEntity()

    val packageName = "com.example.service"
    val className = "MyService"

    val generatedSrc =
      ValueEntitySourceGenerator.valueEntitySource(
        service,
        entity,
        packageName,
        className
      )

    assertEquals(
      generatedSrc,
      """|/* This code was generated by Akka Serverless tooling.
         | * As long as this file exists it will not be re-generated.
         | * You are free to make changes to this file.
         | */
         |package com.example.service;
         |
         |import com.example.service.persistence.EntityOuterClass;
         |import com.external.Empty;
         |
         |/** A value entity. */
         |public class MyService extends AbstractMyService {
         |  @SuppressWarnings("unused")
         |  private final String entityId;
         |
         |  public MyService(ValueEntityContext context) {
         |    this.entityId = context.entityId();
         |  }
         |
         |  @Override
         |  public EntityOuterClass.MyState emptyState() {
         |    throw new UnsupportedOperationException("Not implemented yet, replace with your empty entity state");
         |  }
         |
         |  @Override
         |  public Effect<Empty> set(EntityOuterClass.MyState currentState, ServiceOuterClass.SetValue command) {
         |    return effects().error("The command handler for `Set` is not implemented, yet");
         |  }
         |
         |  @Override
         |  public Effect<ServiceOuterClass.MyState> get(EntityOuterClass.MyState currentState, ServiceOuterClass.GetValue command) {
         |    return effects().error("The command handler for `Get` is not implemented, yet");
         |  }
         |}""".stripMargin
    )
  }

  test("Abstract ValueEntity source") {
    val service = TestData.simpleEntityService()
    val entity = TestData.valueEntity()
    val packageName = "com.example.service"
    val className = "MyService"

    val generatedSrc =
      EntityServiceSourceGenerator.interfaceSource(service, entity, packageName, className)
    assertEquals(
      generatedSrc,
      """|/* This code is managed by Akka Serverless tooling.
         | * It will be re-generated to reflect any changes to your protobuf definitions.
         | * DO NOT EDIT
         | */
         |package com.example.service;
         |
         |import com.akkaserverless.javasdk.valueentity.ValueEntityBase;
         |import com.example.service.persistence.EntityOuterClass;
         |import com.external.Empty;
         |
         |/** A value entity. */
         |public abstract class AbstractMyService extends ValueEntityBase<EntityOuterClass.MyState> {
         |
         |  public abstract Effect<Empty> set(EntityOuterClass.MyState currentState, ServiceOuterClass.SetValue setValue);
         |  public abstract Effect<ServiceOuterClass.MyState> get(EntityOuterClass.MyState currentState, ServiceOuterClass.GetValue getValue);
         |
         |}""".stripMargin
    )
  }

  test("ValueEntity generated handler") {
    val service = TestData.simpleEntityService()
    val entity = TestData.valueEntity()
    val packageName = "com.example.service"
    val className = "MyService"

    val generatedSrc =
      ValueEntitySourceGenerator.valueEntityHandler(service, entity, packageName, className)

    assertEquals(
      generatedSrc,
      """|/* This code is managed by Akka Serverless tooling.
         | * It will be re-generated to reflect any changes to your protobuf definitions.
         | * DO NOT EDIT
         | */
         |package com.example.service;
         |
         |import com.akkaserverless.javasdk.impl.AnySupport;
         |import com.akkaserverless.javasdk.impl.EntityExceptions;
         |import com.akkaserverless.javasdk.impl.valueentity.AdaptedCommandContextWithState;
         |import com.akkaserverless.javasdk.lowlevel.ValueEntityHandler;
         |import com.akkaserverless.javasdk.valueentity.CommandContext;
         |import com.akkaserverless.javasdk.valueentity.ValueEntityBase;
         |import com.example.service.persistence.EntityOuterClass;
         |import com.external.Empty;
         |import com.google.protobuf.Any;
         |import com.google.protobuf.Descriptors;
         |import com.google.protobuf.GeneratedMessageV3;
         |import java.util.Optional;
         |import scalapb.UnknownFieldSet;
         |
         |/** A value entity handler */
         |public class MyServiceHandler implements ValueEntityHandler {
         |
         |  public static final Descriptors.ServiceDescriptor serviceDescriptor =
         |      ServiceOuterClass.getDescriptor().findServiceByName("MyService");
         |  public static final String entityType = "MyValueEntity";
         |
         |  private final MyService entity;
         |  
         |  public MyServiceHandler(MyService entity) {
         |    this.entity = entity;
         |  }
         |
         |  @Override
         |  public ValueEntityBase.Effect<? extends GeneratedMessageV3> handleCommand(
         |      Any command, Any state, CommandContext<Any> context) throws Throwable {
         |      
         |    EntityOuterClass.MyState parsedState =
         |      EntityOuterClass.MyState.parseFrom(state.getValue());
         |
         |    CommandContext<EntityOuterClass.MyState> adaptedContext =
         |        new AdaptedCommandContextWithState(context, parsedState);
         |
         |    entity.setCommandContext(Optional.of(adaptedContext));
         |    
         |    try {
         |      switch (context.commandName()) {
         |
         |        case "Set":
         |          return entity.set(
         |              parsedState,
         |              ServiceOuterClass.SetValue.parseFrom(command.getValue()));
         |
         |        case "Get":
         |          return entity.get(
         |              parsedState,
         |              ServiceOuterClass.GetValue.parseFrom(command.getValue()));
         |
         |        default:
         |          throw new EntityExceptions.EntityException(
         |              context.entityId(),
         |              context.commandId(),
         |              context.commandName(),
         |              "No command handler found for command ["
         |                  + context.commandName()
         |                  + "] on "
         |                  + entity.getClass().toString());
         |      }
         |    } finally {
         |      entity.setCommandContext(Optional.empty());
         |    }
         |  }
         |  
         |  @Override
         |  public com.google.protobuf.any.Any emptyState() {
         |    return com.google.protobuf.any.Any.apply(
         |        AnySupport.DefaultTypeUrlPrefix()
         |          + "/"
         |          + EntityOuterClass.MyState.getDescriptor().getFullName(),
         |        entity.emptyState().toByteString(),
         |        UnknownFieldSet.empty());
         |  }
         |}""".stripMargin
    )
  }

  test("ValueEntity test source") {
    val service = TestData.simpleEntityService()
    val entity = TestData.valueEntity()

    val packageName = "com.example.service"
    val implClassName = "MyServiceImpl"
    val testClassName = "MyServiceTest"

    val generatedSrc =
      EntityServiceSourceGenerator.testSource(
        service,
        entity,
        packageName,
        implClassName,
        testClassName
      )
    assertEquals(
      generatedSrc,
      """|/* This code was initialised by Akka Serverless tooling.
         | * As long as this file exists it will not be re-generated.
         | * You are free to make changes to this file.
         | */
         |
         |package com.example.service;
         |
         |import com.akkaserverless.javasdk.valueentity.CommandContext;
         |import com.example.service.persistence.EntityOuterClass;
         |import com.external.Empty;
         |import org.junit.Test;
         |import org.mockito.*;
         |
         |import static org.junit.Assert.assertThrows;
         |
         |public class MyServiceTest {
         |    private String entityId = "entityId1";
         |    private MyServiceImpl entity;
         |    private CommandContext<EntityOuterClass.MyState> context = Mockito.mock(CommandContext.class);
         |    
         |    @Test
         |    public void setTest() {
         |        entity = new MyServiceImpl(entityId);
         |        
         |        // TODO: write your mock here
         |        // Mockito.when(context.[...]).thenReturn([...]);
         |        
         |        // TODO: set fields in command, and update assertions to verify implementation
         |        // assertEquals([expected],
         |        //    entity.set(ServiceOuterClass.SetValue.newBuilder().build(), context);
         |        // );
         |    }
         |    
         |    @Test
         |    public void getTest() {
         |        entity = new MyServiceImpl(entityId);
         |        
         |        // TODO: write your mock here
         |        // Mockito.when(context.[...]).thenReturn([...]);
         |        
         |        // TODO: set fields in command, and update assertions to verify implementation
         |        // assertEquals([expected],
         |        //    entity.get(ServiceOuterClass.GetValue.newBuilder().build(), context);
         |        // );
         |    }
         |}""".stripMargin
    )
  }

}
